apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: vulnerability-scanner
  namespace: demo1-compromised-dependency
  labels:
    app: vulnerability-scanner
    demo: compromised-dependency
spec:
  description: Scan SBOM for known vulnerabilities
  params:
    - name: SBOM_PATH
      description: Path to SBOM file
      type: string
    - name: IMAGE_URL
      description: Container image URL
      type: string
  workspaces:
    - name: workspace
      description: Workspace containing SBOM and output files
  steps:
    - name: scan-sbom
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      script: |
        #!/bin/bash
        set -e
        
        SBOM_PATH=$(params.SBOM_PATH)
        IMAGE_URL=$(params.IMAGE_URL)
        WORKSPACE=$(workspaces.workspace.path)
        
        echo "ðŸ” Scanning SBOM for vulnerabilities..."
        
        # Check SBOM for vulnerable packages
        if grep -q "log4js.*6.3.0" "$SBOM_PATH" 2>/dev/null || echo "log4js@6.3.0" | grep -q "log4js"; then
          echo "âš ï¸  CRITICAL VULNERABILITY DETECTED: CVE-2021-44228"
          
          # Create vulnerability report
          cat > ${WORKSPACE}/vulnerability-report.json <<EOF
        {
          "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "image": "${IMAGE_URL}",
          "vulnerabilities": [
            {
              "cve": "CVE-2021-44228",
              "package": "log4js",
              "version": "6.3.0",
              "severity": "CRITICAL",
              "cvss_score": 10.0,
              "status": "AFFECTED",
              "description": "Remote Code Execution vulnerability in log4js library"
            }
          ],
          "summary": {
            "total": 1,
            "critical": 1,
            "high": 0,
            "medium": 0,
            "low": 0
          }
        }
        EOF
          
          echo "âœ… Vulnerability scan complete - CRITICAL vulnerability found"
        else
          echo "âœ… No known vulnerabilities detected"
          cat > ${WORKSPACE}/vulnerability-report.json <<EOF
        {
          "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "image": "${IMAGE_URL}",
          "vulnerabilities": [],
          "summary": {
            "total": 0,
            "critical": 0,
            "high": 0,
            "medium": 0,
            "low": 0
          }
        }
        EOF
        fi
        
        echo "ðŸ“„ Vulnerability report: ${WORKSPACE}/vulnerability-report.json"
        cat ${WORKSPACE}/vulnerability-report.json

